<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ†ãƒ³ãƒçŸ¥è¦šå®Ÿé¨“ï¼ˆA/Bè‡ªç”±å†ç”Ÿï¼‰</title>
<style>
  body {
    font-family: "Yu Gothic", sans-serif;
    background: #f8faf8;
    text-align: center;
    margin: 0;
    padding: 12px;
  }

  .card {
    background: white;
    display: inline-block;
    width: 95%;               /* ã‚¹ãƒãƒ›ç”»é¢å¹…ã«åˆã‚ã›ã‚‹ */
    max-width: 600px;         /* ãƒ‘ã‚½ã‚³ãƒ³ã§ã¯åºƒãŒã‚Šã™ããªã„ã‚ˆã†ã« */
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    margin-top: 16px;
  }

  h1, h2 {
    font-size: 1.4rem;
    margin-bottom: 12px;
  }

  p {
    font-size: 1.1rem;
    line-height: 1.6;
  }

  input, select {
    font-size: 1rem;
    padding: 8px;
    margin: 8px;
    width: 80%;
    max-width: 300px;
  }

  textarea {
    width: 90%;
    max-width: 500px;
    height: 180px;
    font-size: 0.9rem;
  }

  button {
    font-size: 1.2rem;
    padding: 14px 24px;
    border-radius: 12px;
    border: none;
    background: #4CAF50;
    color: white;
    cursor: pointer;
    margin: 12px;
    width: 45%;
    max-width: 200px;
  }

  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  #sameBtn, #diffBtn {
    margin-top: 60px;
  }

  /* ğŸŒ¸ ã‚¹ãƒãƒ›ç”»é¢ç”¨ã«æ–‡å­—ã‚„ä½™ç™½ã‚’å°‘ã—å¤§ããã™ã‚‹ */
  @media (max-width: 600px) {
    h1, h2 { font-size: 1.3rem; }
    p { font-size: 1rem; }
    button {
      width: 90%;
      font-size: 1.1rem;
      margin-top: 10px;
    }
  }
</style>
</head>
<body>
  <div class="card" id="welcome">
    <h1>éŸ³æ¥½ãƒ†ãƒ³ãƒã®é•å’Œæ„Ÿå®Ÿé¨“</h1>
    <p>ABã‚’ãã‚Œãã‚Œå†ç”Ÿã—ã¦ã€ãµãŸã¤ã®ãƒ†ãƒ³ãƒãŒã€ŒåŒã˜ã€ã‹ã€Œé•ã†ã€ã‹ã‚’ç­”ãˆã¦ãã ã•ã„ã€‚<br>æº–å‚™ã§ããŸã‚‰ã€Œé–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
    <button onclick="showForm()">é–‹å§‹ã™ã‚‹</button>
  </div>

  <div class="card" id="form" style="display:none; margin-top:18px;">
    <!-- <h2>è¢«é¨“è€…æƒ…å ±</h2> -->
    å¹´é½¢ï¼š<input type="number" id="age" min="10" max="100"><br>
    æ€§åˆ¥ï¼š
    <select id="gender"><option value="">é¸ã‚“ã§ãã ã•ã„</option><option>å¥³æ€§</option><option>ç”·æ€§</option><option>ãã®ä»–</option></select><br>
    <!-- éŸ³æ¥½çµŒé¨“ï¼š
    <select id="experience"><option value="">é¸ã‚“ã§ãã ã•ã„</option><option>ãªã—</option><option>å°‘ã—ï¼ˆè¶£å‘³ï¼‰</option><option>ã‚ã‚‹ï¼ˆéƒ¨æ´»ç­‰ï¼‰</option><option>å°‚é–€çš„</option></select><br> -->
    æ™®æ®µã‚ˆãä½¿ã†éŸ³æ¥½ã‚¢ãƒ—ãƒªï¼š
    <select id="musicApp">
      <option value="">é¸ã‚“ã§ãã ã•ã„</option>
      <option>YouTube</option><option>YouTube Music</option><option>Spotify</option><option>Apple Music</option>
      <option>Amazon Music</option><option>LINE Music</option><option>SoundCloud</option><option>ãã®ä»–</option>
    </select><br><br>
    <button onclick="startExperiment()">å®Ÿé¨“é–‹å§‹</button>
  </div>

  <div class="card" id="experiment" style="margin-top:18px;">
    <h2>è©¦è¡Œ <span id="trialNum">1</span> / 20</h2>
    <p id="instr">Aã¨Bã‚’å†ç”Ÿã—ã¦ã€ãµãŸã¤ã®ãƒ†ãƒ³ãƒãŒã€ŒåŒã˜ã€ã‹ã€Œé•ã†ã€ã‹ã‚’ç›´è¦³çš„ã«é¸ã‚“ã§ãã ã•ã„ã€‚</p>

    <audio id="playerA" src="https://drive.google.com/uc?export=download&id=1a9D_RZBM6D3BCcsnP9MNlq-KQBQK2_im"></audio>
    <audio id="playerB" src="https://drive.google.com/uc?export=download&id=1a9D_RZBM6D3BCcsnP9MNlq-KQBQK2_im"></audio><br>

    <button id="playA" onclick="playSound('A')">Aã‚’å†ç”Ÿ</button>
    <button id="playB" onclick="playSound('B')">Bã‚’å†ç”Ÿ</button><br>

   <div id="buttons">
  <button id="sameBtn" onclick="respond(true)" disabled>åŒã˜</button>
  <button id="diffBtn" onclick="respond(false)" disabled>é•ã†</button>
</div>

    <p id="status" style="color:#666; margin-top:12px;"></p>
  </div>

  <div class="card" id="end" style="margin-top:18px;">
    <h2>çµ‚äº†ã§ã™ã€‚ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚</h2>
    <p>ãƒ‡ãƒ¼ã‚¿ã‚’ä»¥ä¸‹ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€è…åŸã«é€ä¿¡ã—ã¦ãã ã•ã„ã€‚</p>
    <p>ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼ï¼</p>
    <button onclick="downloadCSV()">CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button><br><br>
    <textarea id="log" readonly></textarea>
  </div>

<script>
const TOTAL_TRIALS = 20;
const MIN_RATE = 0.50, MAX_RATE = 1.50, STEP = 0.02;
const SAME_PROB = 0.3;
const speedSteps = [];
for (let r = MIN_RATE; r <= MAX_RATE + 1e-9; r += STEP) speedSteps.push(parseFloat(r.toFixed(2)));
const centerIndex = speedSteps.indexOf(1.00);
let stepIndex = centerIndex;
let trial = 1;
let history = [];
let subjectInfo = {};
let consecutiveCorrectDifferent = 0;
let csvContent = ""; 

function showForm() {
  document.getElementById('welcome').style.display = 'none';
  document.getElementById('form').style.display = 'block';
}

async function startExperiment() {
  const age = document.getElementById('age').value;
  const gender = document.getElementById('gender').value;
  //const experience = document.getElementById('experience').value;
  const musicApp = document.getElementById('musicApp').value;
  if (!age || !gender  || !musicApp) {
    alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  subjectInfo = { age, gender, musicApp };

  document.getElementById('form').style.display = 'none';
  document.getElementById('experiment').style.display = 'block';
  prepareTrial();
}

function prepareTrial() {
  const isSameTrial = Math.random() < SAME_PROB;
  const targetRate = speedSteps[stepIndex];
  const changedIsA = (!isSameTrial) && (Math.random() < 0.5);
  const A_rate = (isSameTrial ? 1.00 : (changedIsA ? targetRate : 1.00));
  const B_rate = (isSameTrial ? 1.00 : (changedIsA ? 1.00 : targetRate));

  window._currentTrial = { trial: trial, isSameTrial, changedIsA, A_rate, B_rate, stepIndex };
  updateStatus(`A/Bã‚’å†ç”Ÿã—ã¦ãã ã•ã„ã€‚`);
}

function playSound(label) {
  const info = window._currentTrial;
  if (!info) return;
  const player = (label === 'A') ? document.getElementById('playerA') : document.getElementById('playerB');
  player.pause();
  player.currentTime = 0;
  const rate = (label === 'A') ? info.A_rate : info.B_rate;
  player.playbackRate = rate;
  player.play();
  document.getElementById('sameBtn').disabled = false;
  document.getElementById('diffBtn').disabled = false;
}

function respond(isSameButton) {
  const info = window._currentTrial;
  if (!info) return;
  const subjectSaysSame = !!isSameButton;
  const trialWasSame = !!info.isSameTrial;
  const correct = (trialWasSame && subjectSaysSame) || (!trialWasSame && !subjectSaysSame);

  history.push({
    trial: info.trial, isSameTrial: info.isSameTrial, changedIsA: info.changedIsA,
    A_rate: info.A_rate, B_rate: info.B_rate, stepIndex: info.stepIndex,
    subjectSaysSame, correct
  });

  if (!info.isSameTrial) {
    if (correct) {
      consecutiveCorrectDifferent++;
      if (consecutiveCorrectDifferent >= 2) {
        stepIndex = Math.max(0, stepIndex - 1);
        consecutiveCorrectDifferent = 0;
      }
    } else {
      stepIndex = Math.min(speedSteps.length - 1, stepIndex + 1);
      consecutiveCorrectDifferent = 0;
    }
  } else {
    if (!subjectSaysSame) {
      stepIndex = Math.min(speedSteps.length - 1, stepIndex + 1);
    }
  }

  trial++;
  if (trial > TOTAL_TRIALS) return finishExperiment();
  document.getElementById('trialNum').textContent = trial;
  document.getElementById('sameBtn').disabled = true;
  document.getElementById('diffBtn').disabled = true;
  prepareTrial();
}

function updateStatus(s) {
  document.getElementById('status').textContent = s;
}

function finishExperiment() {
  document.getElementById('experiment').style.display = 'none';
  document.getElementById('end').style.display = 'block';

  // âœ… è‹±èªå¤‰æ›
  const genderEng = subjectInfo.gender === "å¥³æ€§" ? "female" :
                    subjectInfo.gender === "ç”·æ€§" ? "male" : "other";
//   const expEng =
//     subjectInfo.experience === "ãªã—" ? "none" :
//     subjectInfo.experience === "å°‘ã—ï¼ˆè¶£å‘³ï¼‰" ? "hobby" :
//     subjectInfo.experience === "ã‚ã‚‹ï¼ˆéƒ¨æ´»ç­‰ï¼‰" ? "club" :
//     subjectInfo.experience === "å°‚é–€çš„" ? "professional" : "unknown";

  const header = ['age','gender','musicApp','trial','isSameTrial','changedIsA','A_rate','B_rate','stepIndex','subjectSaysSame','correct'];
  let txt = header.join(',') + '\n';
  history.forEach(h=>{
    txt += `${subjectInfo.age},${genderEng},${subjectInfo.musicApp},${h.trial},${h.isSameTrial},${h.changedIsA},${h.A_rate},${h.B_rate},${h.stepIndex},${h.subjectSaysSame},${h.correct}\n`;
  });

  document.getElementById('log').value = txt;
  csvContent = txt;
}

function downloadCSV() {
  if (!csvContent || csvContent.trim() === "") {
    alert("ã¾ã å®Ÿé¨“çµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚å®Ÿé¨“ã‚’æœ€å¾Œã¾ã§è¡Œã£ã¦ãã ã•ã„ã€‚");
    return;
  }
  // âœ… BOMä»˜ãUTF-8ã§å‡ºåŠ›
  const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
  const blob = new Blob([bom, csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'tempo_same_diff_results.csv';
  a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>






